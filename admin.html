<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin Panel - Mama Waithira Salon</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <!-- Header -->
  <header class="header container">
    <div class="brand">
      <img class="logo" src="assets/logo.svg" alt="logo"/>
      <h1>Salon Admin</h1>
    </div>
    <div class="nav">
      <a href="index.html">Site</a>
      <a href="dashboard.html">Dashboard</a>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container main-admin">
    <section class="card fade-up">
      <h2>All Bookings</h2>
      <div id="adminList" class="admin-list">Loading bookings...</div>
    </section>
  </main>

  <!-- Scripts -->
  <script type="module">
    import { db, auth } from "./firebase.js";
    import { collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    // Admin email whitelist
    const adminEmails = ["donthetechie@gmail.com"];

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    // Check if current user is admin
    auth.onAuthStateChanged(user => {
      if (!user || !adminEmails.includes(user.email)) {
        document.body.innerHTML = "<p style='padding:30px;font-size:1.2rem'>Access denied — admin only</p>";
        return;
      }

      // Real-time bookings listener
      const bookingsRef = collection(db, "bookings");
      onSnapshot(bookingsRef, snapshot => {
        const adminList = document.getElementById("adminList");
        adminList.innerHTML = "";
        if (snapshot.empty) {
          adminList.innerHTML = "<div class='small'>No bookings yet</div>";
          return;
        }

        snapshot.forEach(docSnap => {
          const b = docSnap.data();
          const div = document.createElement("div");
          div.className = "booking-item";
          div.innerHTML = `
            <div class="booking-info">
              <strong>${b.service}</strong>
              <div class="small">${b.date} • ${b.time}</div>
              <div class="small">User: ${b.email}</div>
              <div class="small">Status: <b>${b.status}</b></div>
            </div>
            <div class="booking-actions">
              ${b.status === "pending" ? `<button class="btn approve-btn" data-id="${docSnap.id}">Approve</button>
              <button class="btn reject-btn" data-id="${docSnap.id}">Reject</button>` : ""}
              <button class="btn delete-btn" data-id="${docSnap.id}">Delete</button>
            </div>
          `;
          adminList.appendChild(div);
        });

        // Approve / Reject / Delete handlers
        adminList.querySelectorAll(".approve-btn").forEach(btn => {
          btn.addEventListener("click", async e => {
            const id = e.target.dataset.id;
            await updateDoc(doc(db, "bookings", id), { status: "approved" });
          });
        });

        adminList.querySelectorAll(".reject-btn").forEach(btn => {
          btn.addEventListener("click", async e => {
            const id = e.target.dataset.id;
            await updateDoc(doc(db, "bookings", id), { status: "rejected" });
          });
        });

        adminList.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async e => {
            const id = e.target.dataset.id;
            if (confirm("Delete this booking?")) {
              await deleteDoc(doc(db, "bookings", id));
            }
          });
        });
      });
    });
  </script>
  
</body>
</html>
